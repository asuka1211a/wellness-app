      - name: Run AI change (Aider)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e

          git config user.name  "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"

          BR="ai/issue-${{ github.event.issue.number || github.run_id }}"
          git checkout -b "$BR"

          MODEL="${{ steps.model.outputs.model }}"

          # 使えるキーだけフラグに追加
          FLAGS="--model \"$MODEL\" --commit --yes --message-file .aider/issue.txt --edit-format diff"
          if [ -n "$OPENAI_API_KEY" ]; then
            FLAGS="$FLAGS --openai-api-key \"$OPENAI_API_KEY\""
          fi
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            FLAGS="$FLAGS --anthropic-api-key \"$ANTHROPIC_API_KEY\""
          fi

          # Aider 実行（対象ファイルの指定はせず、Aiderに任せる）
          eval aider $FLAGS

          # 変更があればコミットを追加して push
          if ! git diff --quiet; then
            git add -A
            git commit -m "feat(ai): apply changes for issue #${{ github.event.issue.number || github.run_id }}"
          fi

          git push -u origin "$BR"